<!DOCTYPE html>
<html>
<head>
    <title>Timetable Viewer</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        table {
            width: 90%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
            vertical-align: top;
        }

        th {
            background-color: lightblue;
        }

        .title {
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
        }

        select {
            padding: 6px;
            font-size: 14px;
            margin: 10px 0 20px 0;
        }

        .highlight-batch {
            color: red;
            padding: 4px;
            display: block;
        }
    </style>
</head>

<body>

<h2>Upload Timetable CSV</h2>
<input type="file" id="csvFile" accept=".csv">

<br><br>

<label><b>View Mode:</b></label><br>
<select id="viewSelect">
    <option value="">-- Select Option --</option>
</select>

<div id="tables"></div>

<script>
let csvData = [];

/* ================= Load CSV ================= */
document.getElementById("csvFile").addEventListener("change", function () {
    Papa.parse(this.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function (result) {
            csvData = result.data;
            populateDropdown(csvData);
        }
    });
});

/* ================= Populate Dropdown ================= */
function populateDropdown(data) {
    const select = document.getElementById("viewSelect");
    select.innerHTML = '<option value="">-- Select Option --</option>';

    select.innerHTML += `
        <option value="ALL_BATCH">ALL TIMETABLES (Batch-wise)</option>
        <option value="ALL_FACULTY">ALL FACULTY (Individual)</option>
    `;

    const faculties = [...new Set(
        data.map(r => r.FACULTY).filter(Boolean)
    )];

    faculties.forEach(f => {
        const opt = document.createElement("option");
        opt.value = `FAC_${f}`;
        opt.textContent = f;
        select.appendChild(opt);
    });

    select.onchange = () => handleView(select.value);
}

/* ================= Handle View ================= */
function handleView(value) {
    const container = document.getElementById("tables");
    container.innerHTML = "";
    if (!value) return;

    if (value === "ALL_BATCH") {
        renderAllBatchTimetables();
    }
    else if (value === "ALL_FACULTY") {
        const faculties = [...new Set(csvData.map(r => r.FACULTY).filter(Boolean))];
        faculties.forEach(f => renderFacultyTimetable(f));
    }
    else if (value.startsWith("FAC_")) {
        const faculty = value.replace("FAC_", "");
        renderFacultyTimetable(faculty);
    }
}

/* ================= Batch-wise ================= */
function renderAllBatchTimetables() {
    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];
    const timetable = {};

    csvData.forEach(r => {
        if (!r.BATCH || !r.DAY || !r.SESSION) return;

        if (!timetable[r.BATCH]) timetable[r.BATCH] = {};
        if (!timetable[r.BATCH][r.DAY])
            timetable[r.BATCH][r.DAY] = { FN: "", AN: "" };

        timetable[r.BATCH][r.DAY][r.SESSION] =
            `<b>${r.COURSE}</b><br>
             Room: ${r.ROOM}<br>
             Faculty: ${r.FACULTY}`;
    });

    const container = document.getElementById("tables");

    for (const batch in timetable) {
        const title = document.createElement("div");
        title.className = "title";
        title.textContent = `Batch: ${batch}`;
        container.appendChild(title);

        container.appendChild(buildTable(timetable[batch], false));
    }
}

/* ================= Faculty-wise (Merged) ================= */
function renderFacultyTimetable(faculty) {
    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];
    const tableData = {};
    days.forEach(d => tableData[d] = { FN: [], AN: [] });

    csvData
        .filter(r => r.FACULTY?.trim() === faculty.trim())
        .forEach(r => {
            const highlight = r.BATCH === "VI-SU-B2";
            tableData[r.DAY][r.SESSION].push(
                `<div class="${highlight ? 'highlight-batch' : ''}">
                    <b>${r.COURSE}</b><br>
                    Batch: ${r.BATCH}<br>
                    Room: ${r.ROOM}
                 </div>`
            );
        });

    const container = document.getElementById("tables");
    const title = document.createElement("div");
    title.className = "title";
    title.textContent = `Faculty: ${faculty}`;
    container.appendChild(title);

    container.appendChild(buildTable(tableData, true));
}

/* ================= Common Table Builder ================= */
function buildTable(data, isArray) {
    const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];
    const table = document.createElement("table");

    let html = `
        <tr>
            <th>DAY</th>
            <th>FN</th>
            <th rowspan="7">L<br>U<br>N<br>C<br>H</th>
            <th>AN</th>
        </tr>
    `;

    days.forEach(d => {
        const fn = isArray ? data[d].FN.join("<hr>") : data[d]?.FN || "";
        const an = isArray ? data[d].AN.join("<hr>") : data[d]?.AN || "";

        html += `
            <tr>
                <td>${d}</td>
                <td>${fn}</td>
                <td>${an}</td>
            </tr>
        `;
    });

    table.innerHTML = html;
    return table;
}
</script>

</body>
</html>
